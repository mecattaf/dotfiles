# ═════════════════════════════════════════════════════════════════════════════
# 🔄 LLAMA-SWAP - Local LLM Router
# Generated by Chezmoi - DO NOT EDIT MANUALLY
# ═════════════════════════════════════════════════════════════════════════════

[Unit]
Description=llama-swap - Local LLM Model Router
After=network-online.target {{ .infrastructure.network.name }}.network.service
Requires={{ .infrastructure.network.name }}.network.service

[Container]
Image={{ .infrastructure.services.llama_swap.image }}
AutoUpdate=registry
ContainerName={{ .infrastructure.services.llama_swap.container_name }}

# ═════════════════════════════════════════════════════════════════════════════
# 🌐 NETWORK
# ═════════════════════════════════════════════════════════════════════════════
Network={{ .infrastructure.network.name }}.network

# ═════════════════════════════════════════════════════════════════════════════
# 📍 PUBLISHED PORT (for LiteLLM and Caddy to access)
# ═════════════════════════════════════════════════════════════════════════════
{{- if .infrastructure.services.llama_swap.published_port }}
PublishPort={{ .infrastructure.services.llama_swap.bind | default "127.0.0.1" }}:{{ .infrastructure.services.llama_swap.published_port }}:{{ .infrastructure.services.llama_swap.port }}
{{- end }}

# ═════════════════════════════════════════════════════════════════════════════
# 💾 VOLUMES
# ═════════════════════════════════════════════════════════════════════════════

# Podman socket - allows llama-swap to spawn ramalama containers
Volume=/run/user/%U/podman/podman.sock:/run/podman/podman.sock:Z

# RamaLama model cache - read-only access to downloaded models
Volume={{ .chezmoi.homeDir }}/.local/share/ramalama:/root/.local/share/ramalama:ro,Z

# llama-swap configuration file
Volume=%h/.config/containers/systemd/llama-swap/config.yaml:/app/config.yaml:ro,Z

# Persistent data volume for llama-swap state
Volume={{ .infrastructure.services.llama_swap.volume }}:/app/data:Z

# ═════════════════════════════════════════════════════════════════════════════
# 🔐 SECURITY
# ═════════════════════════════════════════════════════════════════════════════

# Allow container to control podman (spawn ramalama containers)
PodmanArgs=--security-opt=label=disable

# ═════════════════════════════════════════════════════════════════════════════
# 🌍 ENVIRONMENT
# ═════════════════════════════════════════════════════════════════════════════

# Podman socket location (for spawning containers)
Environment=PODMAN_SOCK=unix:///run/podman/podman.sock

# Home directory for ramalama
Environment=HOME=/root

# ═════════════════════════════════════════════════════════════════════════════
# 🔧 HEALTH CHECK
# ═════════════════════════════════════════════════════════════════════════════
HealthCmd=curl -f http://localhost:{{ .infrastructure.services.llama_swap.port }}/health || exit 1
HealthInterval=30s
HealthTimeout=5s
HealthRetries=3
HealthStartPeriod=10s

# ═════════════════════════════════════════════════════════════════════════════
# 🚀 SERVICE
# ═════════════════════════════════════════════════════════════════════════════
[Service]
Slice=llm.slice
TimeoutStartSec=300
Restart=on-failure
RestartSec=10

[Install]
# No WantedBy - dependencies via After/Requires
