[Unit]
Description={{ .infrastructure.services.searxng.description }}
After=network-online.target {{ .infrastructure.network.name }}.network.service
After=searxng-redis.service
Requires={{ .infrastructure.network.name }}.network.service
Wants=searxng-redis.service

[Container]
Image={{ .infrastructure.services.searxng.image }}
AutoUpdate=registry
ContainerName={{ .infrastructure.services.searxng.container_name }}

# ═════════════════════════════════════════════════════════════════════════════
# 🌐 NETWORK
# ═════════════════════════════════════════════════════════════════════════════
Network={{ .infrastructure.network.name }}.network

# ═════════════════════════════════════════════════════════════════════════════
# 📍 PUBLISHED PORT (for Caddy to access)
# ═════════════════════════════════════════════════════════════════════════════
{{- if .infrastructure.services.searxng.published_port }}
PublishPort={{ .infrastructure.services.searxng.bind | default "127.0.0.1" }}:{{ .infrastructure.services.searxng.published_port }}:{{ .infrastructure.services.searxng.port }}
{{- end }}

# ═════════════════════════════════════════════════════════════════════════════
# 💾 VOLUMES
# ═════════════════════════════════════════════════════════════════════════════
Volume={{ .infrastructure.services.searxng.volume }}:/etc/searxng:Z

# ═════════════════════════════════════════════════════════════════════════════
# 🔐 ENVIRONMENT - Auto-generated from infrastructure.services
# ═════════════════════════════════════════════════════════════════════════════

# Base URL (auto-generated from Tailscale config)
Environment=SEARXNG_BASE_URL={{ .searxng.base_url }}

# Redis connection (auto-generated from infrastructure.services)
Environment=SEARXNG_REDIS_URL={{ .searxng.redis_url }}

# UWSGI worker configuration (8 workers, 4 threads for AMD Strix Halo)
Environment=SEARXNG_UWSGI_WORKERS=8
Environment=SEARXNG_UWSGI_THREADS=4

# Disable rate limiting (local instance only)
Environment=SEARXNG_LIMITER=false

# ═════════════════════════════════════════════════════════════════════════════
# 🔧 HEALTH CHECK
# ═════════════════════════════════════════════════════════════════════════════
HealthCmd=wget --no-verbose --tries=1 --spider http://localhost:{{ .infrastructure.services.searxng.port }} || exit 1
HealthInterval=30s
HealthTimeout=5s
HealthRetries=3
HealthStartPeriod=30s

# ═════════════════════════════════════════════════════════════════════════════
# 🚀 SERVICE
# ═════════════════════════════════════════════════════════════════════════════
[Service]
Slice=llm.slice
TimeoutStartSec=900
Restart=on-failure
RestartSec=10

[Install]
# No WantedBy - dependencies via After/Requires
