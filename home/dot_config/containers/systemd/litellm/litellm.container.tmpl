[Unit]
Description={{ .infrastructure.services.litellm.description }}
After=network-online.target {{ .infrastructure.network.name }}.network.service
{{- range .infrastructure.services.litellm.requires }}
After={{ . }}.service
{{- end }}
Requires={{ .infrastructure.network.name }}.network.service
{{- range .infrastructure.services.litellm.requires }}
Wants={{ . }}.service
{{- end }}

[Container]
Image={{ .infrastructure.services.litellm.image }}
AutoUpdate=registry
ContainerName={{ .infrastructure.services.litellm.container_name }}

# ═════════════════════════════════════════════════════════════════════════════
# 🌐 NETWORK
# ═════════════════════════════════════════════════════════════════════════════
Network={{ .infrastructure.network.name }}.network

# ═════════════════════════════════════════════════════════════════════════════
# 📍 PUBLISHED PORT (for Caddy to access)
# ═════════════════════════════════════════════════════════════════════════════
{{- if .infrastructure.services.litellm.published_port }}
PublishPort={{ .infrastructure.services.litellm.bind | default "127.0.0.1" }}:{{ .infrastructure.services.litellm.published_port }}:{{ .infrastructure.services.litellm.port }}
{{- end }}

# ═════════════════════════════════════════════════════════════════════════════
# 💾 VOLUMES
# ═════════════════════════════════════════════════════════════════════════════
Volume=%h/.config/containers/systemd/litellm/litellm.yaml:/app/config.yaml:ro,Z

# ═════════════════════════════════════════════════════════════════════════════
# 🔐 ENVIRONMENT - Auto-generated from infrastructure.services
# ═════════════════════════════════════════════════════════════════════════════

# LiteLLM Master Key
Environment=LITELLM_MASTER_KEY={{ .secrets.api_keys.litellm_master }}

# Database connection (auto-generated from infrastructure.services)
Environment=DATABASE_URL=postgresql://{{ .infrastructure.services.litellm_postgres.db_user }}@{{ .infrastructure.services.litellm_postgres.hostname }}:{{ .infrastructure.services.litellm_postgres.port }}/{{ .infrastructure.services.litellm_postgres.db_name }}

# Redis connection (auto-generated from infrastructure.services)
Environment=REDIS_HOST={{ .infrastructure.services.litellm_redis.hostname }}
Environment=REDIS_PORT={{ .infrastructure.services.litellm_redis.port }}

# Settings
Environment=STORE_MODEL_IN_DB=true
Environment=USE_AIOHTTP_TRANSPORT=true

# API Keys (from secrets)
Environment=OPENAI_API_KEY={{ .secrets.llm_providers.openai }}
Environment=ANTHROPIC_API_KEY={{ .secrets.llm_providers.anthropic }}
Environment=GEMINI_API_KEY={{ .secrets.llm_providers.gemini }}

# ═════════════════════════════════════════════════════════════════════════════
# 🚀 EXECUTION
# ═════════════════════════════════════════════════════════════════════════════
Exec=--config /app/config.yaml --port {{ .infrastructure.services.litellm.port }} --num_workers 2

# ═════════════════════════════════════════════════════════════════════════════
# 🔧 HEALTH CHECK
# ═════════════════════════════════════════════════════════════════════════════
HealthCmd=curl -f http://localhost:{{ .infrastructure.services.litellm.port }}/health/readiness || exit 1
HealthInterval=30s
HealthTimeout=10s
HealthRetries=3
HealthStartPeriod=30s

# ═════════════════════════════════════════════════════════════════════════════
# 🚀 SERVICE
# ═════════════════════════════════════════════════════════════════════════════
[Service]
Slice=llm.slice
TimeoutStartSec=900
Restart=on-failure
RestartSec=10

[Install]
# No WantedBy - dependencies via After/Requires
