# ═════════════════════════════════════════════════════════════════════════════
# 🎤 WHISPER - Speech-to-Text Service
# Generated by Chezmoi - DO NOT EDIT MANUALLY
# Location: ~/.config/containers/systemd/whisper/whisper.container
# ═════════════════════════════════════════════════════════════════════════════

[Unit]
Description={{ .infrastructure.services.whisper.description }}
After=network-online.target {{ .infrastructure.network.name }}.network.service
Requires={{ .infrastructure.network.name }}.network.service

[Container]
Image={{ .infrastructure.services.whisper.image }}
AutoUpdate=registry
ContainerName={{ .infrastructure.services.whisper.container_name }}

# ═════════════════════════════════════════════════════════════════════════════
# 🌐 NETWORK
# ═════════════════════════════════════════════════════════════════════════════
Network={{ .infrastructure.network.name }}.network

# ═════════════════════════════════════════════════════════════════════════════
# 📍 PUBLISHED PORT (for OpenWebUI to access)
# ═════════════════════════════════════════════════════════════════════════════
{{- if .infrastructure.services.whisper.published_port }}
PublishPort={{ .infrastructure.services.whisper.bind | default "127.0.0.1" }}:{{ .infrastructure.services.whisper.published_port }}:{{ .infrastructure.services.whisper.port }}
{{- end }}

# ═════════════════════════════════════════════════════════════════════════════
# 💾 VOLUMES
# ═════════════════════════════════════════════════════════════════════════════

# Whisper model cache - shared with host for CLI usage
Volume={{ .whisper.cache_dir }}:/root/.cache/huggingface:Z

# ═════════════════════════════════════════════════════════════════════════════
# 🎮 GPU ACCESS (AMD Vulkan)
# ═════════════════════════════════════════════════════════════════════════════

# AMD GPU devices for Vulkan acceleration
AddDevice=/dev/dri
AddDevice=/dev/kfd

# Security options for GPU access
PodmanArgs=--security-opt=label=disable

# ═════════════════════════════════════════════════════════════════════════════
# 🌍 ENVIRONMENT
# ═════════════════════════════════════════════════════════════════════════════

# Whisper model configuration
Environment=WHISPER_MODEL={{ .whisper.model }}
{{- if .whisper.language }}
Environment=WHISPER_LANGUAGE={{ .whisper.language }}
{{- end }}
Environment=WHISPER_BEAM_SIZE={{ .whisper.beam_size }}
Environment=WHISPER_COMPUTE_TYPE={{ .whisper.compute_type }}

# Device configuration (auto detects Vulkan)
Environment=WHISPER_DEVICE={{ .whisper.device }}

# Cache location
Environment=HF_HOME=/root/.cache/huggingface
Environment=TRANSFORMERS_CACHE=/root/.cache/huggingface

# ═════════════════════════════════════════════════════════════════════════════
# 🔧 HEALTH CHECK
# ═════════════════════════════════════════════════════════════════════════════
HealthCmd=wget --no-verbose --tries=1 --spider http://localhost:{{ .infrastructure.services.whisper.port }}/health || exit 1
HealthInterval=30s
HealthTimeout=5s
HealthRetries=3
HealthStartPeriod=30s

# ═════════════════════════════════════════════════════════════════════════════
# 🚀 SERVICE
# ═════════════════════════════════════════════════════════════════════════════
[Service]
Slice=llm.slice
TimeoutStartSec=900
Restart=on-failure
RestartSec=10

[Install]
# No WantedBy - dependencies via After/Requires
