#!/bin/bash

# Enhanced Pomodoro Timer with Waybar Integration
# Location: ~/.config/scroll/scripts/pomodoro

#--- Configuration ---
[[ -n $POMO_FILE ]] && POMO=$POMO_FILE || POMO=$HOME/.local/share/pomo
[[ -n $POMO_WORK_TIME ]] && WORK_TIME=$POMO_WORK_TIME || WORK_TIME=25
[[ -n $POMO_BREAK_TIME ]] && BREAK_TIME=$POMO_BREAK_TIME || BREAK_TIME=5

# Check environment for date commands
if [ "$(uname)" == "Darwin" ] || [ "${POMO_PREFIX_CMDS}" == "true" ]; then
    DATE_CMD="gdate"
    STAT_CMD="gstat"
else
    DATE_CMD="date"
    STAT_CMD="stat"
fi

#--- Waybar Integration Functions ---

function pomo_waybar_signal {
    # Signal waybar to update the pomodoro module
    pkill -RTMIN+8 waybar 2>/dev/null || true
}

function pomo_waybar_output {
    # Generate JSON output for waybar
    if ! pomo_isstopped; then
        pomo_update
        running=$(pomo_stat)
        
        # Calculate work phase progress
        work_left=$(( WORK_TIME*60 - running ))
        if [[ $work_left -lt 0 ]]; then
            # Break phase
            break_left=$(( work_left + BREAK_TIME*60 ))
            total_time=$((BREAK_TIME*60))
            elapsed=$((total_time - break_left))
            phase="break"
            icon="üèñÔ∏è"
            prefix="Break"
        else
            # Work phase
            total_time=$((WORK_TIME*60))
            elapsed=$((total_time - work_left))
            phase="work"
            icon="üçÖ"
            prefix="Focus"
        fi
        
        # Calculate percentage (0-100)
        if [[ $total_time -gt 0 ]]; then
            percentage=$(( (elapsed * 100) / total_time ))
        else
            percentage=0
        fi
        
        # Format remaining time
        if [[ $phase == "work" ]]; then
            remaining_seconds=$work_left
        else
            remaining_seconds=$break_left
        fi
        
        min=$(( remaining_seconds / 60 ))
        sec=$(( remaining_seconds % 60 ))
        time_str=$(printf "%02d:%02d" $min $sec)
        
        # Determine CSS class based on state
        if pomo_ispaused; then
            css_class="paused"
            icon="‚è∏Ô∏è"
            prefix="Paused"
        else
            css_class=$phase
        fi
        
        # Generate CSS class for percentage
        perc_class="perc$(printf "%.0f" $percentage)"
        
        echo "{\"text\":\"$icon\",\"tooltip\":\"$prefix: $time_str remaining\",\"class\":\"$css_class $perc_class\",\"percentage\":$percentage}"
    else
        echo "{\"text\":\"\",\"tooltip\":\"Pomodoro timer stopped\",\"class\":\"stopped\",\"percentage\":0}"
    fi
}

#--- Core Pomodoro Functions ---

function pomo_start {
    test -e "$(dirname -- "$POMO")" || mkdir -p "$(dirname -- "$POMO")"
    :> "$POMO"
    touch "$POMO"
    pomo_waybar_signal
    notify-send "üçÖ Pomodoro Started" "Focus time: ${WORK_TIME} minutes" -t 2000
}

function pomo_isstopped {
    [[ ! -e "$POMO" ]]
    return $?
}

function pomo_stop {
    rm -f "$POMO"
    pomo_waybar_signal
    notify-send "üõë Pomodoro Stopped" -t 1000
}

function pomo_stamp {
    ago=$1
    mtime=$(${DATE_CMD} --date "@$(( $(date +%s) - ago))" +%m%d%H%M.%S)
    :> "$POMO"
    touch -m -t "$mtime" "$POMO"
}

function pomo_ispaused {
    [[ $(wc -l < "$POMO") -gt 0 ]]
    return $?
}

function pomo_pause {
    running=$(pomo_stat)
    if pomo_isstopped; then
        notify-send "‚ö†Ô∏è No Active Timer" "Start a pomodoro session first" -t 1000
        return 1
    elif pomo_ispaused; then
        # Resume
        pomo_stamp "$running"
        pomo_waybar_signal
        notify-send "‚ñ∂Ô∏è Pomodoro Resumed" -t 1000
    else
        # Pause
        echo "$running" > "$POMO"
        pomo_waybar_signal
        notify-send "‚è∏Ô∏è Pomodoro Paused" -t 1000
    fi
}

function pomo_restart {
    if ! pomo_isstopped; then
        pomo_stop
        sleep 0.1
    fi
    pomo_start  # This will call pomo_ensure_services automatically
}

function pomo_update {
    running=$(pomo_stat)
    block_time=$(( (WORK_TIME+BREAK_TIME)*60 ))
    if [[ $running -ge $block_time ]]; then
        ago=$(( running % block_time ))
        mtime=$(${DATE_CMD} --date "@$(( $(date +%s) - ago))" +%m%d%H%M.%S)
        touch -m -t "$mtime" "$POMO"
    fi
}

function pomo_stat {
    [[ -e "$POMO" ]] && running=$(cat "$POMO") || running=0
    if [[ -z $running ]]; then
        pomo_start=$(${STAT_CMD} -c +%Y "$POMO")
        now=$(${DATE_CMD} +%s)
        running=$((now-pomo_start))
    fi
    echo $running
}

function pomo_status {
    if ! pomo_isstopped; then
        pomo_update
        running=$(pomo_stat)
        left=$(( WORK_TIME*60 - running ))
        if [[ $left -lt 0 ]]; then
            left=$(( left + BREAK_TIME*60 ))
            prefix="Break"
            icon="üèñÔ∏è"
        else
            prefix="Focus"
            icon="üçÖ"
        fi
        pomo_ispaused && prefix="Paused" && icon="‚è∏Ô∏è"
        min=$(( left / 60 ))
        sec=$(( left - 60*min ))
        printf "%s %02d:%02d\n" $icon $min $sec
    else
        printf "Timer stopped\n"
    fi
}

function pomo_notify_daemon {
    break_end_msg="Break's over! Time to focus! üçÖ"
    work_end_msg="Great work! Time for a break! üèñÔ∏è"
    
    while true; do
        if [[ -e "$POMO" ]]; then
            pomo_update
            running=$(pomo_stat)
            work_left=$(( WORK_TIME*60 - running ))
            
            if [[ $work_left -gt 0 ]]; then
                # Work phase - wait for work to end
                sleep $work_left
                if [[ -e "$POMO" ]]; then
                    notify-send "üèñÔ∏è Break Time!" "$work_end_msg" -t 5000
                    pomo_waybar_signal
                fi
                sleep 1
            else
                # Break phase - wait for break to end
                break_left=$(( work_left + BREAK_TIME*60 ))
                if [[ $break_left -gt 0 ]]; then
                    sleep $break_left
                    if [[ -e "$POMO" ]]; then
                        notify-send "üçÖ Focus Time!" "$break_end_msg" -t 5000
                        pomo_waybar_signal
                    fi
                    sleep 1
                else
                    sleep 5
                fi
            fi
        else
            sleep 10
        fi
    done
}

function pomo_ensure_services {
    # Ensure waybar progress bar is running
    if ! pgrep -f "waybar.*pomodoro-bar" > /dev/null; then
        waybar -c ~/.config/waybar/pomodoro-bar.json -s ~/.config/waybar/pomodoro-bar.css &
        sleep 0.5  # Give waybar time to start
    fi
    
    # Ensure notification daemon is running
    if ! pgrep -f "pomodoro notify" > /dev/null; then
        ~/.config/scroll/scripts/pomodoro notify &
    fi
}

function pomo_stop_services {
    # Stop waybar progress bar
    pkill -f "waybar.*pomodoro-bar"
    
    # Stop notification daemon
    pkill -f "pomodoro notify"
}

function pomo_menu {
    rofi_dir="$HOME/.config/rofi/pomodoro"
    theme_file="$rofi_dir/pomodoro.rasi"
    
    # Ensure services are running when menu is opened
    pomo_ensure_services
    
    # Create options based on current state
    if pomo_isstopped; then
        options=("üçÖ Start Pomodoro"
                "‚öôÔ∏è Settings"
                "‚ùå Exit")
    elif pomo_ispaused; then
        options=("‚ñ∂Ô∏è Resume"
                "üîÑ Restart"
                "üõë Stop"
                "‚öôÔ∏è Settings"
                "‚ùå Exit")
    else
        options=("‚è∏Ô∏è Pause"
                "üîÑ Restart" 
                "üõë Stop"
                "‚öôÔ∏è Settings"
                "‚ùå Exit")
    fi
    
    # Get current status for prompt
    if ! pomo_isstopped; then
        status=$(pomo_status)
        prompt="$status"
    else
        prompt="Pomodoro Timer"
    fi
    
    # Show menu
    selected=$(printf '%s\n' "${options[@]}" | rofi \
        -dmenu \
        -i \
        -p "$prompt" \
        -theme "$theme_file")
    
    # Execute selection
    case "$selected" in
        "üçÖ Start Pomodoro")
            pomo_start
            ;;
        "‚ñ∂Ô∏è Resume"|"‚è∏Ô∏è Pause")
            pomo_pause
            ;;
        "üîÑ Restart")
            pomo_restart
            ;;
        "üõë Stop")
            pomo_stop
            # When stopped, also stop services to clean up
            pomo_stop_services
            ;;
        "‚öôÔ∏è Settings")
            # Simple settings dialog
            new_work=$(echo -e "15\n20\n25\n30\n45\n60" | rofi -dmenu -p "Work minutes (current: $WORK_TIME)")
            if [[ -n "$new_work" && "$new_work" =~ ^[0-9]+$ ]]; then
                export POMO_WORK_TIME=$new_work
                notify-send "‚öôÔ∏è Settings Updated" "Work time: ${new_work} minutes" -t 1500
            fi
            ;;
        "‚ùå Exit"|"")
            exit 0
            ;;
    esac
}

#--- Command Line Interface ---

case "${1:-menu}" in
    start)
        pomo_start
        ;;
    stop)
        pomo_stop
        ;;
    pause|toggle)
        pomo_pause
        ;;
    restart)
        pomo_restart
        ;;
    status)
        pomo_status
        ;;
    waybar)
        pomo_waybar_output
        ;;
    notify)
        pomo_notify_daemon
        ;;
    menu)
        pomo_menu
        ;;
    signal)
        pomo_waybar_signal
        ;;
    *)
        echo "Usage: $0 {start|stop|pause|restart|status|waybar|notify|menu|signal}"
        echo "  start    - Start new pomodoro session"
        echo "  stop     - Stop current session"
        echo "  pause    - Pause/resume current session"
        echo "  restart  - Restart current session"
        echo "  status   - Show current status"
        echo "  waybar   - Output JSON for waybar"
        echo "  notify   - Run notification daemon"
        echo "  menu     - Show rofi menu (default)"
        echo "  signal   - Signal waybar to update"
        exit 1
        ;;
esac
